### USER ###

- name: Kill all process owned by {{ username }}
  shell: pkill -u {{ username }} || echo

- name: Remove user {{ username }}
  user:
    name: "{{ username }}"
    state: absent
    remove: yes


### POSTGRESQL ###

- name: Check if postgresql-server package is installed
  yum:
    list=postgresql-server
  register: yum_list

- name: Delete db {{ username }}
  postgresql_db:
    name: "{{ username }}"
    state: absent
  become_user: postgres
  become: true
  when: yum_list.results | selectattr("yumstate", "match", "installed") | list | length > 0

- name: Delete db {{ username }}_development
  postgresql_db:
    name: "{{ username }}_development"
    state: absent
  become_user: postgres
  become: true
  when: yum_list.results | selectattr("yumstate", "match", "installed") | list | length > 0

- name: Delete db {{ username }}_test
  postgresql_db:
    name: "{{ username }}_test"
    state: absent
  become_user: postgres
  become: true
  when: yum_list.results | selectattr("yumstate", "match", "installed") | list | length > 0

- name: Delete db {{ username }}_production
  postgresql_db:
    name: "{{ username }}_production"
    state: absent
  become_user: postgres
  become: true
  when: yum_list.results | selectattr("yumstate", "match", "installed") | list | length > 0

- name: Delete postgresql user {{ username }}
  postgresql_user:
    name: "{{ username }}"
    state: absent
  become_user: postgres
  become: true
  when: yum_list.results | selectattr("yumstate", "match", "installed") | list | length > 0


### PASSENGER ###

- name: Delete {{ username }}.conf
  file:
    path: /etc/nginx/conf.d/{{ username }}.conf
    state: absent

- name: Check if nginx package is installed
  yum:
    list=nginx
  register: yum_list

- name: Restart service nginx
  service:
    name: nginx
    state: restarted
    enabled: yes
  when: yum_list.results | selectattr("yumstate", "match", "installed") | list | length > 0


### CLEAN BINARIES IF ASKED ###
- name: Remove nginx
  yum:
    name: nginx
    state: absent
  when: clean_binaries == "yes"

- name: Remove passenger
  yum:
    name: passenger
    state: absent
  when: clean_binaries == "yes"

- name: Remove postgresql
  yum:
    name: postgresql
    state: absent
  when: clean_binaries == "yes"

- name: Check if firewalld package is installed
  yum:
    list=firewalld
  register: yum_list

- name: Close 80 port
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 80
    jump: ACCEPT
    state: absent  
  when: yum_list.results | selectattr("yumstate", "match", "installed") | list | length == 0 and clean_binaries == "yes"